<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KOSTORY - Sistem Keuangan Kost Satria</title>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <style>
    body{font-family:Arial,sans-serif;margin:0;background:#f0f2f5;padding:20px;}
    .container{max-width:900px;margin:auto;background:white;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.1);overflow:hidden;display:none;}
    header{background:#27ae60;color:white;padding:20px;text-align:center;position:relative;}
    h1{margin:0;font-size:2em;}
    nav{background:#2c3e50;color:white;padding:15px;text-align:center;}
    nav button{margin:5px;padding:10px 20px;background:#34495e;border:none;border-radius:5px;color:white;cursor:pointer;}
    nav button:hover{background:#1abc9c;}
    section{padding:20px;display:none;}
    .active{display:block;}
    table{width:100%;border-collapse:collapse;margin:15px 0;}
    th, td{border:1px solid #ddd;padding:10px;text-align:left;}
    th{background:#f2f2f2;}
    input, select{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;}
    button{background:#27ae60;color:white;border:none;padding:10px 15px;border-radius:5px;cursor:pointer;margin:5px 0;}
    button:hover{background:#219653;}
    button:disabled{background:#95a5a6;color:#fff;cursor:not-allowed;}
    .export-btn{background:#e74c3c;}
    .print-btn{background:#d35400 !important;}
    .total{font-weight:bold;background:#f8f9fa;font-size:1.1em;}
    .hidden{display:none !important;}
    .readonly{opacity:0.6;pointer-events:none;}

    #loginPage{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#27ae60,#219653);display:flex;justify-content:center;align-items:center;z-index:9999;}
    .login-box{background:white;padding:50px 40px;border-radius:20px;box-shadow:0 20px 50px rgba(0,0,0,0.4);width:90%;max-width:400px;text-align:center;}
    .login-box h2{margin-bottom:30px;color:#27ae60;font-size:2em;}
    .login-box input{margin:15px 0;padding:14px;border-radius:8px;border:1px solid #ddd;font-size:1.1em;width:100%;box-sizing:border-box;}
    .login-box button{background:#27ae60;padding:14px;font-size:1.2em;width:100%;margin-top:20px;border-radius:8px;}

    .history-box{margin-top:30px;padding:15px;background:#f8f9fa;border-radius:10px;border-left:4px solid #27ae60;}
    .history-title{font-weight:bold;margin-bottom:10px;color:#2c3e50;font-size:0.95em;}
    .transaksi-item{font-size:0.85em;padding:8px 0;border-bottom:1px dashed #ddd;cursor:pointer;transition:0.2s;background:#fff;border-radius:6px;margin:4px 0;}
    .transaksi-item:hover{background:#f0f8f0;}
    .debet{color:#27ae60;font-weight:bold;}
    .kredit{color:#e74c3c;font-weight:bold;}
    .tanggal{font-weight:bold;color:#555;}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:999;}
    .modal-content{background:white;padding:25px;border-radius:12px;width:90%;max-width:420px;box-shadow:0 10px 30px rgba(0,0,0,0.3);}
    .close-modal{font-size:1.5em;cursor:pointer;float:right;color:#aaa;}
    .close-modal:hover{color:#000;}
    .delete-btn{background:#e74c3c;margin-top:10px;}
    .pilih-bulan{margin:15px 0;text-align:center;}
    .pilih-bulan select{padding:10px;font-size:1em;border-radius:8px;margin:0 5px;}
    @media print{.no-print{display:none;}body{background:white;}}
  </style>
</head>
<body>

<!-- [SEMUA HTML SAMA PERSIS SEPERTI YANG KAMU KIRIM] -->
<!-- Login, Main App, Input, Laporan, Backup, Modal → TIDAK DIUBAH SAMA SEKALI -->

<!-- Hanya bagian <script> yang diperbaiki di bawah ini -->

<script>
// CONFIG FIREBASE (sama)
const firebaseConfig = {
  apiKey: "AIzaSyDmVPzOk--IoScJPNMjtF1sDJGiELfpLIA",
  authDomain: "lap-satria.firebaseapp.com",
  databaseURL: "https://lap-satria-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "lap-satria",
  storageBucket: "lap-satria.firebasestorage.app",
  messagingSenderId: "563891405234",
  appId: "1:563891405234:web:e505d804d1eb35f4faa4ab"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const transRef = db.ref('transaksi');

let data = [];
let isAdmin = false;
let editId = null;

function formatRupiah(n){return n.toLocaleString('id-ID');}
function formatTanggal(d){return new Date(d).toLocaleDateString('id-ID',{day:'numeric',month:'short',year:'2-digit'});}

// [semua fungsi login, simpan, history, edit, dll tetap sama]

// === PERBAIKAN UTAMA: Dropdown Bulan & Tahun ===

function populateDropdowns() {
  const bulanNama = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
  const bulanSelect = document.getElementById('pilihBulan');
  const tahunSelect = document.getElementById('pilihTahun');
  const jenis = document.getElementById('jenisLaporan').value;

  // Kosongkan dulu
  bulanSelect.innerHTML = '';
  tahunSelect.innerHTML = '';

  // Ambil semua tahun unik dari data
  const tahunUnik = [...new Set(data.map(t => new Date(t.tanggal).getFullYear()))].sort((a,b) => b - a);
  const sekarang = new Date();
  const tahunIni = sekarang.getFullYear();
  const bulanIni = sekarang.getMonth();

  // Isi tahun (prioritas: tahun dengan data terbaru)
  if (tahunUnik.length === 0) {
    const opt = document.createElement('option');
    opt.value = tahunIni; opt.textContent = tahunIni; opt.selected = true;
    tahunSelect.appendChild(opt);
  } else {
    tahunUnik.forEach(y => {
      const opt = document.createElement('option');
      opt.value = y; opt.textContent = y;
      if (y === tahunUnik[0]) opt.selected = true; // default ke tahun terbaru yang ada data
      tahunSelect.appendChild(opt);
    });
  }

  // Isi bulan jika laporan bulanan
  if (jenis === 'bulanan') {
    document.getElementById('wrapperBulan').style.display = 'inline';
    const selectedTahun = parseInt(tahunSelect.value);

    // Cari bulan apa saja yang ada di tahun terpilih
    const bulanAdaDiTahunIni = [...new Set(
      data
        .filter(t => new Date(t.tanggal).getFullYear() === selectedTahun)
        .map(t => new Date(t.tanggal).getMonth())
    )].sort((a,b) => b - a);

    // Jika ada data di tahun itu, default ke bulan terbaru yang ada data
    const defaultBulan = bulanAdaDiTahunIni.length > 0 ? bulanAdaDiTahunIni[0] : bulanIni;

    for (let i = 0; i < 12; i++) {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = bulanNama[i];
      if (i === defaultBulan) opt.selected = true;
      bulanSelect.appendChild(opt);
    }
  } else {
    document.getElementById('wrapperBulan').style.display = 'none';
  }
}

function hitungLaporan() {
  populateDropdowns(); // ← ini yang bikin dropdown selalu fresh & bisa diganti

  const jenis = document.getElementById('jenisLaporan').value;
  const tahun = parseInt(document.getElementById('pilihTahun').value);
  const bulan = jenis === 'bulanan' ? parseInt(document.getElementById('pilihBulan').value) : null;

  const namaBulan = jenis === 'bulanan' 
    ? document.getElementById('pilihBulan').options[document.getElementById('pilihBulan').selectedIndex].text.toUpperCase() 
    : '';
  const judul = jenis === 'tahunan' ? `LAPORAN TAHUNAN ${tahun}` : `${namaBulan} ${tahun}`;
  document.getElementById('periodeTampil').2innerText = judul;

  let sewa=0,gaji=0,opkost=0,listrik=0,lain=0;

  data.forEach(t => {
    const d = new Date(t.tanggal);
    if (d.getFullYear() !== tahun) return;
    if (bulan !== null && d.getMonth() !== bulan) return;

    if (t.tipe === 'sewa') sewa += t.jumlah;
    else {
      if (t.kategori === 'Gaji') gaji += t.jumlah;
      if (t.kategori === 'Operasional Kost') opkost += t.jumlah;
      if (t.kategori === 'Listrik & Air') listrik += t.jumlah;
      if (t.kategori === 'Lain-lain') lain += t.jumlah;
    }
  });

  const keluar = gaji + opkost + listrik + lain;
  const netto = sewa - keluar;
  const promotion = sewa * 0.05;
  const revenue = netto < 0 ? 0 : netto * 0.10;

  document.getElementById('totalSewa').innerText = formatRupiah(sewa);
  document.getElementById('bruto').innerText = formatRupiah(sewa);
  document.getElementById('detailOperasional').innerHTML = `
    <tr><td>a. Gaji</td><td style="text-align:right">${formatRupiah(gaji)}</td></tr>
    <tr><td>b. Operasional Kost</td><td style="text-align:right">${formatRupiah(opkost)}</td></tr>
    <tr><td>c. Listrik & Air</td><td style="text-align:right">${formatRupiah(listrik)}</td></tr>
    <tr><td>d. Lain-lain</td><td style="text-align:right">${formatRupiah(lain)}</td></tr>`;
  document.getElementById('totalKeluar').innerText = formatRupiah(keluar);
  document.getElementById('netto').innerText = formatRupiah(netto);
  document.getElementById('promotion').innerText = formatRupiah(promotion);
  document.getElementById('revenue').innerText = formatRupiah(revenue);
  document.getElementById('totalSharing').innerText = formatRupiah(promotion + revenue);
}

// Event listener (WAJIB dipanggil ulang saat ganti tahun/bulan)
document.getElementById('jenisLaporan').addEventListener('change', () => {
  populateDropdowns();
  hitungLaporan();
});
document.getElementById('pilihTahun').addEventListener('change', hitungLaporan);
document.getElementById('pilihBulan').addEventListener('change', hitungLaporan);

function show(id){
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='input') tampilkanHistory();
  if(id==='laporan') hitungLaporan(); // ← penting banget ini dipanggil
}

// [semua fungsi lain: exportCSV, backupData, cetakLaporanBulanan, dll tetap 100% sama]

// Init
loadData();
</script>
</body>
</html>
